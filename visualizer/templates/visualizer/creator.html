<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Tileset Creator</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        
        /* 布局 */
        .main-container { display: flex; gap: 50px; margin-top: 30px; }
        .section { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }

        /* 1. 颜色选择器 */
        .color-palette { display: flex; gap: 10px; margin-bottom: 15px; }
        .color-swatch { width: 40px; height: 40px; border-radius: 50%; cursor: pointer; border: 3px solid transparent; transition: transform 0.2s; }
        .color-swatch.active { border-color: #333; transform: scale(1.1); }

        /* 2. 编辑器 (大瓦片) */
        /* 2. 编辑器 (大瓦片) - 使用 clip-path */
        .editor-box { display: flex; flex-direction: column; align-items: center; }
        .large-tile {
            width: 150px; height: 150px; position: relative; margin: 20px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            background: white; /* 背景色 */
        }
        
        /* 通用三角形样式 */
        .quadrant { 
            position: absolute; 
            width: 100%; height: 100%; 
            top: 0; left: 0;
            cursor: pointer; 
            transition: filter 0.2s;
        }
        .quadrant:hover { filter: brightness(0.9); z-index: 10; }
        
        /* 使用 clip-path 精确裁剪点击区域 */
        /* 北 (Top) */
        .q-n { 
            clip-path: polygon(0 0, 100% 0, 50% 50%); 
            background-color: #ddd; /* 默认颜色 */
        }
        /* 南 (Bottom) */
        .q-s { 
            clip-path: polygon(0 100%, 100% 100%, 50% 50%); 
            background-color: #ddd;
        }
        /* 东 (Right) */
        .q-e { 
            clip-path: polygon(100% 0, 100% 100%, 50% 50%); 
            background-color: #ddd;
        }
        /* 西 (Left) */
        .q-w { 
            clip-path: polygon(0 0, 0 100%, 50% 50%); 
            background-color: #ddd;
        }

        /* 3. 状态指示灯 */
        .indicator-box { 
            width: 300px; padding: 20px; text-align: center; margin-top: 20px; 
            background: #eee; border-radius: 8px; font-weight: bold; color: #555; transition: 0.3s;
        }
        .status-success { background-color: #4ecdc4; color: white; } /* 绿色 */
        .status-fail { background-color: #ff6b6b; color: white; }    /* 红色 */

        /* 4. 已添加列表 */
        .tile-list { display: grid; grid-template-columns: repeat(3, 60px); gap: 10px; margin-top: 15px; }
        .mini-tile-wrapper { position: relative; }
        .mini-tile { width: 60px; height: 60px; position: relative; }
        .mini-quad { position: absolute; width: 0; height: 0; border-style: solid; border-width: 30px; }
        
        .delete-btn { 
            position: absolute; top: -5px; right: -5px; width: 20px; height: 20px; 
            background: red; color: white; border-radius: 50%; text-align: center; 
            line-height: 20px; font-size: 12px; cursor: pointer; display: none; 
        }
        .mini-tile-wrapper:hover .delete-btn { display: block; }

    </style>
</head>
<body>

    <h1>Tileset Designer</h1>
    <div style="position: fixed; bottom: 20px; right: 20px;">
    <button onclick="goToPlay()" style="padding: 15px 30px; font-size: 18px; background: #28a745; box-shadow: 0 4px 10px rgba(0,0,0,0.2);">
        ▶ Play / Test Manually
    </button>
</div>
    <p><b>Design tiles to tile a square</b>.</p>

    <div id="statusIndicator" class="indicator-box">
        Not enough tiles / Cannot tile 10x10
    </div>

    <div class="main-container">
        
        <div class="section editor-box">
            <h3>1. Pick Color</h3>
            <div class="color-palette" id="palette"></div>
            
            <h3>2. Paint Tile</h3>
            <div class="large-tile" id="editorTile">
                <div class="quadrant q-n" id="edit-n" onclick="paint('n')"></div>
                <div class="quadrant q-e" id="edit-e" onclick="paint('e')"></div>
                <div class="quadrant q-s" id="edit-s" onclick="paint('s')"></div>
                <div class="quadrant q-w" id="edit-w" onclick="paint('w')"></div>
            </div>

            <button onclick="addTile()">Add Tile to Collection</button>
        </div>

        <div class="section">
            <h3>3. Your Tileset</h3>
            <div id="tileList" class="tile-list">
                </div>
        </div>
    </div>



  {{ colors|json_script:"colors-data" }}

<script>
    const el = document.getElementById('colors-data');
  

const colors = JSON.parse(document.getElementById('colors-data').textContent);

  // 1) Global state (must exist BEFORE any click)
  let currentDraft = { n: 0, e: 0, s: 0, w: 0 };
  let myTileset = [];

  // 2) Pick default color safely
  const defaultColor = (Array.isArray(colors) ? (colors.find(c => c.id === 1) || colors[0]) : null) || { id: 0, hex: '#cccccc' };
  let currentColorHex = defaultColor.hex;
  let currentColorId  = defaultColor.id;

  // 3) Functions
  function init() {
    const p = document.getElementById('palette');
    if (!p) return;

    p.innerHTML = '';
    colors.forEach(c => {
      const div = document.createElement('div');
      div.className = 'color-swatch';
      div.style.backgroundColor = c.hex;
      if (c.id === currentColorId) div.classList.add('active');
      div.onclick = () => {
        currentColorHex = c.hex;
        currentColorId = c.id;
        document.querySelectorAll('.color-swatch').forEach(el => el.classList.remove('active'));
        div.classList.add('active');
      };
      p.appendChild(div);
    });

    updateEditorVisuals();
  }

  function paint(dir) {
    currentDraft[dir] = currentColorId;
    updateEditorVisuals();
  }

  function updateEditorVisuals() {
            // 根据 ID 找 Hex
            const getHex = (id) => colors.find(c => c.id === id).hex;
            
            // 更新四个三角形的背景颜色 (background-color)
            document.getElementById('edit-n').style.backgroundColor = getHex(currentDraft.n);
            document.getElementById('edit-e').style.backgroundColor = getHex(currentDraft.e);
            document.getElementById('edit-s').style.backgroundColor = getHex(currentDraft.s);
            document.getElementById('edit-w').style.backgroundColor = getHex(currentDraft.w);
        }

  function addTile() {
    myTileset.push({ ...currentDraft });
    renderList();
    checkFeasibility();
  }

  function removeTile(index) {
    myTileset.splice(index, 1);
    renderList();
    checkFeasibility();
  }

  function renderList() {
    const container = document.getElementById('tileList');
    if (!container) return;
    container.innerHTML = '';

    const getHex = (id) => (colors.find(c => c.id === id)?.hex) || '#cccccc';

    myTileset.forEach((tile, index) => {
      const wrapper = document.createElement('div');
      wrapper.className = 'mini-tile-wrapper';

      wrapper.innerHTML = `
        <div class="mini-tile">
          <div class="mini-quad" style="top:0;left:0; border-width:30px 30px 0 30px; border-color: ${getHex(tile.n)} transparent transparent transparent;"></div>
          <div class="mini-quad" style="top:0;right:0; border-width:30px 30px 30px 0; border-color: transparent ${getHex(tile.e)} transparent transparent;"></div>
          <div class="mini-quad" style="bottom:0;left:0; border-width:0 30px 30px 30px; border-color: transparent transparent ${getHex(tile.s)} transparent;"></div>
          <div class="mini-quad" style="top:0;left:0; border-width:30px 0 30px 30px; border-color: transparent transparent transparent ${getHex(tile.w)};"></div>
        </div>
        <div class="delete-btn" onclick="removeTile(${index})">×</div>
      `;
      container.appendChild(wrapper);
    });
  }

  async function checkFeasibility() {
    const indicator = document.getElementById('statusIndicator');
    if (!indicator) return;

    if (myTileset.length === 0) {
      indicator.className = 'indicator-box';
      indicator.innerText = "Add some tiles to start checking...";
      return;
    }

    indicator.innerText = "Checking...";
    indicator.className = 'indicator-box';

    try {
      const response = await fetch('api/check/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ tiles: myTileset })
      });

      const data = await response.json();
      if (data.can_tile) {
        indicator.className = 'indicator-box status-success';
        indicator.innerText = "SUCCESS! Can tile 10x10 area.";
      } else {
        indicator.className = 'indicator-box status-fail';
        indicator.innerText = "Cannot tile 10x10 area yet.";
      }
    } catch (error) {
      console.error("Error:", error);
    }
  }

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  // 4) Expose functions for inline onclick="..."
  window.paint = paint;
  window.addTile = addTile;
  window.removeTile = removeTile;

  // 5) Init after DOM is ready
  document.addEventListener('DOMContentLoaded', init);
  function goToPlay() {
    if (myTileset.length === 0) {
        alert("Please create at least one tile first!");
        return;
    }
    // 1. 保存当前设计到 LocalStorage
    localStorage.setItem('myTileset', JSON.stringify(myTileset));
    
    // 2. 跳转到 Play 页面
    window.location.href = '/play/';
    }
</script>
</body>
</html>